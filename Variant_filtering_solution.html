<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Variant Filtering Workflow</title>
<style>
body {
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.6;
  max-width: 900px;
  margin: auto;
  padding: 40px;
  background: #ffffff;
  color: #222;
}
h1, h2, h3, h4 {
  color: #1a237e;
}
pre {
  background: #f4f4f4;
  color: #000;
  padding: 15px;
  overflow-x: auto;
  border-radius: 5px;
  border: 1px solid #ddd;
}
code {
  background: #f4f4f4;
  padding: 2px 4px;
  border-radius: 3px;
  color: #000;
}
a {
  color: #1565c0;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
hr {
  border: 0;
  height: 1px;
  background: #ccc;
  margin: 30px 0;
}
</style>
</head>
<body>

<h2>Variant Filtering</h2>
<p>Download the VCF file to be used from <a href="https://zenodo.org/records/15173226">https://zenodo.org/records/15173226</a></p>

<p>Variant filtering can be done using different tools like <b>bcftools</b>, <b>vcftools</b>, <b>gatk</b>, etc.  
Here we will provide the solutions for filtering using <b>vcftools</b>.  
Please note that the downloaded VCF file already has a few filters applied.</p>

<hr/>

<h3>Applying Variant Filters on a VCF File</h3>

<h4>Install vcftools in a new conda environment</h4>
<pre><code>conda create -n vcftools -c bioconda vcftools
conda activate vcftools
</code></pre>

<h4>Provided VCF file</h4>
<p><b>Filename:</b> machali_Aligned_rangeWideMerge_strelka_update2_BENGAL_mac3_passOnly_biallelicOnly_noIndels_minMAF0Pt05_chr_E2_minDP3.recode.vcf.gz</p>
<p>When applying new filters, change the name of the output file to reflect the new filters that have been applied.</p>

<h4>Applying base quality, genotype quality, and HWE filters</h4>
<pre><code>vcftools --gzvcf machali_Aligned_rangeWideMerge_strelka_update2_BENGAL_mac3_passOnly_biallelicOnly_noIndels_minMAF0Pt05_chr_E2_minDP3.recode.vcf.gz \
--minQ 30 --minGQ 30 --hwe 0.05 \
--out machali_..._minQ30_minGQ30_hwe_0.05 --recode
</code></pre>

<ul>
<li><b>--minQ</b>: Minimum base quality (removes low-quality base calls).</li>
<li><b>--minGQ</b>: Minimum genotype quality (keeps reliable genotype calls).</li>
<li><b>--hwe</b>: Removes variants deviating from Hardy-Weinberg equilibrium.</li>
</ul>

<h4>Remove Indels</h4>
<pre><code>vcftools --vcf machali_..._hwe_0.05.recode.vcf --remove-indels \
--out machali_..._rmvIndels_hwe_0.05 --recode
</code></pre>

<h4>Apply Individual Missingness Filter</h4>
<pre><code>vcftools --vcf machali_..._hwe_0.05.recode.vcf --missing-indv
</code></pre>

<p>The command above generates <code>out.imiss</code>.  
Remove individuals with missing data fraction &gt; 0.6:</p>

<pre><code>vcftools --vcf machali_..._hwe_0.05.recode.vcf \
--remove &lt;(awk '$5 &gt; 0.6 {print $1}' out.imiss) \
--recode --out machali_..._imiss_0.6
</code></pre>

<h4>Apply Variant Missingness Filter (10%â€“90%)</h4>
<pre><code>for miss in {10..90..10}; do
  perc=$(echo "scale=2; $miss / 100" | bc)
  vcftools --vcf machali_..._imiss_0.6.recode.vcf \
           --max-missing $perc \
           --out machali_..._imiss_0.6_miss_${miss} --recode
done
</code></pre>

<h4>Count Remaining Variants</h4>
<pre><code>for miss in {10..90..10}; do
  count=$(grep -vc "^#" machali_..._miss_${miss}.recode.vcf)
  echo "${miss} ${count}" &gt;&gt; variant_counts.txt
done
</code></pre>

<h4>Plot the Results (R + ggplot2)</h4>
<pre><code>conda create -n ggplot2 -c conda-forge r-ggplot2
conda activate ggplot2

R -e "library(ggplot2); library(scales);
data <- read.table('variant_counts.txt', header=FALSE, col.names=c('Missingness','Variants'));
p <- ggplot(data, aes(x=Missingness, y=Variants)) +
     geom_line(color='blue') + geom_point(color='red') +
     ggtitle('Number of Passed Variants vs. Missingness Filter') +
     xlab('Max Missingness (%)') + ylab('Number of Variants') +
     scale_y_continuous(labels = comma) + scale_x_continuous(limits = c(10,90)) +
     theme_minimal();
ggsave('variant_plot.png', plot=p)"
</code></pre>

<h4>Apply Max Missing 0.6 Filter</h4>
<pre><code>vcftools --vcf machali_..._imiss_0.6.recode.vcf \
--max-missing 0.6 --out machali_..._miss_0.6 --recode
</code></pre>

<h4>Calculate Site Mean Depth</h4>
<pre><code>vcftools --vcf machali_..._miss_0.6.recode.vcf --site-mean-depth --out depth
</code></pre>

<h4>Find 95% Depth Range (R)</h4>
<pre><code>R
depth_data <- read.table("depth.ldepth.mean", header = TRUE)
depths <- depth_data$MEAN_DEPTH
lower_bound <- quantile(depths, 0.025, na.rm = TRUE)
upper_bound <- quantile(depths, 0.975, na.rm = TRUE)
cat("Middle 95% range:", lower_bound, "to", upper_bound, "\n")
</code></pre>

<h4>Apply Depth Range Filter</h4>
<pre><code>vcftools --vcf machali_..._miss_0.6.recode.vcf \
--min-meanDP 12.8302 --max-meanDP 24.6604 \
--recode --out machali_..._mid95percentile
</code></pre>

<h4>Remove Zoo Samples (ZSB)</h4>
<pre><code>grep 'ZSB' out.imiss | awk '{print $1}' > zsb_samples.txt

vcftools --vcf machali_..._mid95percentile.recode.vcf \
--remove zsb_samples.txt \
--out machali_..._mid95percentile_noZSB --recode
</code></pre>

<hr/>
<p><i>Authored workflow for variant filtering using vcftools (Pranav & Nithin)</i></p>

</body>
</html>
